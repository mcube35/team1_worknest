<h2>{{ user.username }}님의 업무 현황</h2>
{% if user.role == 'admin' %}
<form method="POST" action="/add" enctype="multipart/form-data">
  <input name="title" placeholder="제목" required>
  <input name="team" placeholder="팀명" required>
  <select name="status">
    <option>대기</option>
    <option>진행중</option>
    <option>완료</option>
  </select>
  <input type="date" name="date" required>
  <input type="file" name="file">
  <button type="submit">업무 추가</button>
</form>
{% endif %}

<table border="1">
  <tr><th>제목</th><th>팀</th><th>상태</th><th>마감일</th><th>파일</th><th>관리</th></tr>
  {% for task in tasks %}
  <tr {% if task.due_soon %}style="background-color: #ffeeee"{% endif %}>
    <td>{{ task.title }}</td>
    <td>{{ task.team }}</td>
    <td>{{ task.status }}</td>
    <td>{{ task.date }}</td>
    <td>{% if task.filename %}<a href="/uploads/{{ task.filename }}">다운로드</a>{% endif %}</td>
    <td>
      <a href="/edit/{{ task._id }}">수정</a>
      {% if user.role == 'admin' %}
      <a href="/delete/{{ task._id }}" onclick="return confirm('삭제할까요?')">삭제</a>
      {% endif %}
    </td>
  </tr>
  {% endfor %}
</table>

<h3>팀별 업무 시각화</h3>
<canvas id="taskChart"></canvas>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
fetch('/chart-data')
  .then(res => res.json())
  .then(data => {
    new Chart(document.getElementById('taskChart'), {
      type: 'bar',
      data: {
        labels: data.labels,
        datasets: [{ label: '업무 수', data: data.counts }]
      }
    });
  });
</script>