<!DOCTYPE html>
<html>
<head>
    <title>업무 등록</title>
</head>
<body>
    <h1>업무 등록</h1>
    <form id="task-form" action="{{ url_for('create_task') }}" method="post" enctype="multipart/form-data">
        <p>
            <label>제목:</label><br>
            <input type="text" name="title" required>
        </p>
        <p>업무유형:
            <select name="type">
                <option value="개발">개발</option>
                <option value="디자인">디자인</option>
                <option value="기획">기획</option>
                <option value="테스트">테스트</option>
            </select>
        </p>
        <p>
            <label>설명:</label><br>
            <textarea name="description" rows="4"></textarea>
        </p>
        <p>상태:
            <select name="status">
                <option value="대기">대기</option>
                <option value="진행중">진행중</option>
                <option value="완료">완료</option>
            </select>
        </p>
        <p>
            <label>담당자:</label><br>
            <input type="text" name="assigned_to" required>
        </p>
        <p>
            <label>마감일:</label><br>
            <input type="date" name="deadline" required>
        </p>
        <p>
            <label>진행도(%):</label><br>
            <input type="number" name="progress" min="0" max="100" value="0" required>
        </p>

        <p>
            <label>첨부파일:</label><br>
            <div id="file-list"></div>
            <input type="file" id="file-input" accept=".pdf,.png,.jpg,.jpeg,.docx,.xlsx,.txt" multiple style="display:none;">
            <button type="button" id="add-files-btn">파일 선택</button>
        </p>

        <p>
            <button type="submit">등록</button>
        </p>
    </form>
    <p><a href="{{ url_for('project_list') }}">[목록으로]</a></p>

<script>
const fileInput = document.getElementById('file-input');
const fileListDiv = document.getElementById('file-list');
const addFilesBtn = document.getElementById('add-files-btn');
const form = document.getElementById('task-form');

let filesArray = [];

addFilesBtn.addEventListener('click', () => {
    fileInput.click();
});

fileInput.addEventListener('change', (e) => {
    // 새로 선택한 파일들을 배열에 추가
    for (const file of e.target.files) {
        filesArray.push(file);
    }
    updateFileList();
    // input 초기화 (동일 파일 선택 허용 위해)
    fileInput.value = '';
});

function updateFileList() {
    fileListDiv.innerHTML = '';
    filesArray.forEach((file, idx) => {
        const fileDiv = document.createElement('div');
        fileDiv.textContent = file.name + ' ';
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.textContent = '삭제';
        removeBtn.addEventListener('click', () => {
            filesArray.splice(idx, 1);
            updateFileList();
        });
        fileDiv.appendChild(removeBtn);
        fileListDiv.appendChild(fileDiv);
    });
}

form.addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(form);
    // filesArray에 있는 파일들을 formData에 append
    filesArray.forEach(file => {
        formData.append('file', file);
    });

    fetch(form.action, {
        method: form.method,
        body: formData
    }).then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        } else {
            // 에러 처리 필요 시 추가
            alert('업무 등록에 실패했습니다.');
        }
    });
});
</script>
</body>
</html>